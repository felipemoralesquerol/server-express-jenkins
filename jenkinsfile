pipeline {
 agent any 

 tools {
     nodejs "node"
 }

 parameters {
     string(name: 'container_name', defaultValue: 'node-app-p11', description: 'Nombre del contenedor')
     string(name: 'image_name', defaultValue: 'node-app-p11-image', description: 'Nombre de la imagen')
     string(name: 'tag_image', defaultValue: 'lts', description: 'Tag de la imagen')
     string(name: 'container_port', defaultValue: '4000', description: 'Puerto del container')
 }

 stages {
      stage('build') {
      steps {
         dir('') {
              script {
                  try {
                    sh 'docker stop ${container_name}'
                    sh 'docker rm ${container_name}'
                    sh 'docker rmi ${image_name}:${tag_image}'

                  } catch (err) {
                      echo err.getMessage()
                      echo "Error detected, but we will continue."
                  }
              }
             
             sh 'docker build -t ${image_name}:${tag_image} .' 
          }

      }
    }  
  
      stage('deploy') {
      steps {
         dir('') {
               sh 'docker run -d  -p ${container_port}:4000 --name ${container_name} ${image_name}:${tag_image}'
              }
          }

      }

 }

}