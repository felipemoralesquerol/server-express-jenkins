pipeline {
 agent any 

 tools {
     nodejs "node"
 }

 parameters {
     string(name: 'container_name', defaultValue: 'node-app-p11', description: 'Nombre del contenedor')
     string(name: 'image_name', defaultValue: 'node-app-p11-image', description: 'Nombre de la imagen')
     string(name: 'tag_image', defaultValue: 'lts', description: 'Tag de la imagen')
     string(name: 'container_port', defaultValue: '80', description: 'Puerto del container')
 }

 stages {
    stage('install') {
      steps {
          git branch: 'develop', url: 'https://github.com/felipemoralesquerol/aca-sprint1-meeting11-server-express.git'
          dir('') {
              sh 'npm install'
              sh 'npm audit fix'
          }

      }
    } 
      stage('build') {
      steps {
         dir('') {
              script {
                  try {
                    sh 'docker stop ${container_name}'
                    sh 'docker rm ${container_name}'
                    sh 'docker rmi ${image_name}:${tag_image}'

                  } catch (Exception e) {
                      echo 'Exception ' + e.toString()
                  }
              }
             sh 'npm run build'
             sh 'docker build -t ${image_name}:${tag_image} .' 
          }

      }
    }  
  
      stage('deploy') {
      steps {
         dir('') {
               sh 'docker run -d ${image_name}:80 --name ${container_name} ${image_name}:${tag_image}'
              }
          }

      }

 }

}